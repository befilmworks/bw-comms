<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BW-COMMS PRO v3.5</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0a0a0a; color: #e5e5e5; font-family: 'Inter', sans-serif; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .radio-card { background: #1a1a1a; border: 1px solid #333; transition: all 0.2s; cursor: pointer; }
        .radio-card.frei { border-top: 4px solid #10b981; }
        .radio-card.besetzt { border-top: 4px solid #ef4444; background: #2a1a1a; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    </style>
</head>
<body class="p-4 pb-24">
    <header class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
        <div>
            <h1 class="text-2xl font-black italic text-yellow-500 tracking-tighter">BEFILM WORKS</h1>
            <p class="text-[10px] text-white/40 tracking-[0.2em] uppercase">Communications Cloud v3.5</p>
        </div>
        <div id="connection-status" class="flex items-center gap-2 bg-white/5 px-3 py-1 rounded-full border border-white/10">
            <span class="status-dot bg-red-500" id="sync-dot"></span>
            <span class="text-[10px] uppercase font-bold text-white/60">Live</span>
        </div>
    </header>

    <div class="bg-[#111] border border-white/10 rounded-2xl p-4 mb-8 shadow-2xl">
        <div id="chat-messages" class="h-32 overflow-y-auto mb-4 space-y-2 text-sm"></div>
        <div class="flex gap-2">
            <input id="chat-input" class="flex-grow bg-white/5 border border-white/10 rounded-lg p-3 text-sm focus:outline-none focus:border-yellow-500" placeholder="Funkspruch absetzen...">
            <button onclick="sendMsg()" class="bg-yellow-500 text-black font-bold px-6 rounded-lg hover:bg-yellow-400 transition-colors">SEND</button>
        </div>
    </div>

    <div id="radio-grid" class="grid-container"></div>

    <script>
        // HIER WAR DER FEHLER: Nur eine Deklaration erlaubt!
        const SUB_URL = "https://wvimqnjbpzdklrxorlpo.supabase.co";
        const SUB_KEY = "sb_publishable_YlyScDFX7pEa1oEWWoNx-A_R_h3-jm9";
        const sbClient = window.supabase.createClient(SUB_URL, SUB_KEY);

        async function initApp() {
            try {
                const { data: funken, error } = await sbClient.from('funken').select('*').order('id', { ascending: true });
                if (error) throw error;
                if (funken) {
                    renderGrid(funken);
                    document.getElementById('sync-dot').classList.replace('bg-red-500', 'bg-green-500');
                }

                sbClient.channel('db-changes').on('postgres_changes', { event: '*', schema: 'public', table: 'funken' }, () => {
                    fetchUpdate();
                }).subscribe();
            } catch (err) {
                console.error("Fehler beim Laden:", err);
            }
        }

        async function fetchUpdate() {
            const { data } = await sbClient.from('funken').select('*').order('id', { ascending: true });
            if (data) renderGrid(data);
        }

        function renderGrid(items) {
            const grid = document.getElementById('radio-grid');
            grid.innerHTML = items.map(f => `
                <div class="radio-card ${f.status} p-3 rounded-xl shadow-lg relative overflow-hidden">
                    <div class="text-[10px] text-white/30 font-bold mb-1">UNIT</div>
                    <div class="text-xl font-black text-yellow-500">#${f.id}</div>
                    <div class="text-[10px] mt-2 uppercase font-bold truncate ${f.status === 'frei' ? 'text-green-500' : 'text-red-500'}">
                        ${f.user || (f.status === 'frei' ? 'VERFÃœGBAR' : 'BESETZT')}
                    </div>
                </div>
            `).join('');
        }

        async function sendMsg() {
            const input = document.getElementById('chat-input');
            if(!input.value) return;
            await sbClient.from('chat_messages').insert([{sender: 'Admin', text: input.value}]);
            input.value = '';
        }

        initApp();
    </script>
</body>
</html>
