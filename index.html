<script>
    // CONFIG & SUPABASE SETUP
    const SUB_URL = "https://wvimqnjbpzdklrxorlpo.supabase.co";
    const SUB_KEY = "sb_publishable_YlyScDFX7pEa1oEWWoNx-A_R_h3-jm9";
    
    // Die Instanz muss anders heißen als die Library selbst
    const sb = supabase.createClient(SUB_URL, SUB_KEY); 

    let config = { visibleCount: 100, view: 'detail' }; // Auf 100 erhöht
    let funken = [];
    let messages = [];

    // INITIAL LOAD
    async function init() {
        await fetchAllData();
        renderList();
        updateChatUI();
        
        // REALTIME SUBSCRIPTION (sb statt supabase)
        sb.channel('custom-all-channel')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'funken' }, () => { fetchAllData(); })
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat_messages' }, (payload) => { 
            messages.push(payload.new);
            updateChatUI();
        })
        .subscribe();
    }

    async function fetchAllData() {
        setSyncStatus('syncing');
        // Abfragen über 'sb'
        const { data: fData } = await sb.from('funken').select('*').order('id', { ascending: true });
        const { data: cData } = await sb.from('chat_messages').select('*').order('created_at', { ascending: false }).limit(20);
        
        if (fData) {
            funken = fData.map(f => ({ ...f, user: f.user || '', hasHeadset: f.has_headset, isBroken: f.is_broken }));
            renderList();
        }
        if (cData) {
            messages = cData.reverse();
            updateChatUI();
        }
        setSyncStatus('idle');
    }

    function setSyncStatus(status) {
        const el = document.getElementById('sync-indicator');
        el.className = `w-2 h-2 rounded-full mt-2 mr-2 transition-colors duration-500 ${status === 'syncing' ? 'bg-bw-gold animate-pulse' : 'bg-green-500'}`;
    }

    // DATABASE ACTIONS (sb statt supabase)
    async function updateFunkeDB(id, updates) {
        const { error } = await sb.from('funken').update(updates).eq('id', id);
        if (error) console.error(error);
    }

    async function sendChatMessage(type, text) {
        await sb.from('chat_messages').insert([{ sender: 'System', text, type }]);
    }

    // ... Rest deiner renderList() und UI Funktionen bleibt absolut gleich ...
</script>
