<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BW COMMS CLOUD</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #1a1a1a; color: white; font-family: sans-serif; }
        .bg-card { background-color: #000000; border: 1px solid rgba(255,255,255,0.1); }
        .status-free { border-top: 4px solid #10b981; }
        .status-busy { border-top: 4px solid #ef4444; }
    </style>
</head>
<body class="p-4">
    <header class="mb-6 flex justify-between items-center">
        <h1 class="text-xl font-bold text-yellow-500 underline">BW COMMS PRO v3.5</h1>
        <div id="status-dot" class="w-3 h-3 rounded-full bg-red-500"></div>
    </header>

    <div id="debug-msg" class="bg-red-900/50 text-red-200 p-2 rounded mb-4 text-xs hidden"></div>

    <div class="bg-card p-4 rounded-xl mb-6 shadow-xl">
        <div id="chat-box" class="h-40 overflow-y-auto mb-2 text-sm border-b border-white/10 pb-2"></div>
        <div class="flex gap-2">
            <input id="chat-in" class="flex-grow bg-white/5 border border-white/20 p-2 rounded text-sm" placeholder="Nachricht...">
            <button onclick="onSend()" class="bg-yellow-500 text-black px-4 py-2 rounded font-bold">SEND</button>
        </div>
    </div>

    <div id="list-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
        <p class="col-span-full text-center py-10 opacity-50">Lade Datenbank...</p>
    </div>

    <script>
        const SUB_URL = "https://wvimqnjbpzdklrxorlpo.supabase.co";
        const SUB_KEY = "sb_publishable_YlyScDFX7pEa1oEWWoNx-A_R_h3-jm9";
        
        // Initialisiere Supabase sicher
        let supabase;
        try {
            supabase = window.supabase.createClient(SUB_URL, SUB_KEY);
        } catch(e) {
            document.getElementById('debug-msg').innerText = "Supabase Library nicht geladen!";
            document.getElementById('debug-msg').classList.remove('hidden');
        }

        async function loadData() {
            const dot = document.getElementById('status-dot');
            try {
                // Test-Abfrage
                const { data, error } = await supabase.from('funken').select('*').order('id', { ascending: true });
                
                if (error) throw error;

                dot.classList.replace('bg-red-500', 'bg-green-500');
                renderList(data);
            } catch (err) {
                console.error(err);
                document.getElementById('debug-msg').innerText = "Fehler: " + err.message + " (Hast du SQL ausgeführt?)";
                document.getElementById('debug-msg').classList.remove('hidden');
            }
        }

        function renderList(items) {
            const grid = document.getElementById('list-grid');
            if(!items || items.length === 0) {
                grid.innerHTML = "<p class='col-span-full'>Tabelle leer. Bitte SQL-Befehl in Supabase ausführen!</p>";
                return;
            }
            grid.innerHTML = items.map(f => `
                <div class="bg-card p-3 rounded-lg ${f.status === 'frei' ? 'status-free' : 'status-busy'}">
                    <div class="text-yellow-500 font-bold">#${f.id}</div>
                    <div class="text-xs uppercase truncate">${f.user || '---'}</div>
                </div>
            `).join('');
        }

        async function onSend() {
            const input = document.getElementById('chat-in');
            if(!input.value) return;
            await supabase.from('chat_messages').insert([{sender: 'User', text: input.value, type: 'user'}]);
            input.value = '';
            loadData(); // Refresh
        }

        loadData();
    </script>
</body>
</html>
